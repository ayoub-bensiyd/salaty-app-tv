name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Create dummy audio files
      run: |
        mkdir -p app/src/main/res/raw
        touch app/src/main/res/raw/adhan_makkah.mp3
        touch app/src/main/res/raw/iqama.mp3
        
    - name: Build Release APK
      run: ./gradlew assembleRelease --stacktrace
      
    - name: Get version name
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        release_name: ğŸ•Œ Prayer TV - ${{ steps.version.outputs.VERSION }}
        body: |
          ## ğŸ“± ØªØ·Ø¨ÙŠÙ‚ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© - ÙˆØ¬Ø¯Ø©
          
          ### âœ¨ Ø§Ù„Ù…ÙŠØ²Ø§Øª
          - âœ… Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ø±Ø§Ø¨Ø·Ø© Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ)
          - âœ… Ø£Ø°Ø§Ù† ÙˆØ¥Ù‚Ø§Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù†
          - âœ… ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ
          - âœ… Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ø¨Ø± Ø§Ù„Ù‡Ø§ØªÙ (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª)
          - âœ… ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
          
          ### ğŸ“¥ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª
          
          1. Ø­Ù…Ù‘Ù„ Ù…Ù„Ù `app-release-unsigned.apk`
          2. âš ï¸ **Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹**: ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª ÙŠØ¯ÙˆÙŠØ§Ù‹:
             - `adhan_makkah.mp3` - ØµÙˆØª Ø§Ù„Ø£Ø°Ø§Ù†
             - `iqama.mp3` - ØµÙˆØª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©
          3. Ø§Ù†Ø³Ø® APK Ø¥Ù„Ù‰ USB ÙˆØ«Ø¨Ù‘ØªÙ‡ Ø¹Ù„Ù‰ Android Box
          4. ÙØ¹Ù‘Ù„ "Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©" ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          
          ### ğŸ“– Ø§Ù„ØªÙˆØ«ÙŠÙ‚
          
          Ø±Ø§Ø¬Ø¹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) Ù„Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©.
          
          ### ğŸ” Ø±Ù‚Ù… PIN Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
          
          `1234`
          
          ---
          
          **ØµÙÙ†Ø¹ Ø¨Ù€ â¤ï¸ Ù„Ù…Ø³Ù„Ù…ÙŠ ÙˆØ¬Ø¯Ø©ØŒ Ø§Ù„Ù…ØºØ±Ø¨**
        draft: false
        prerelease: false
        
    - name: Upload Release APK
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: app/build/outputs/apk/release/app-release-unsigned.apk
        asset_name: prayer-tv-oujda-${{ steps.version.outputs.VERSION }}.apk
        asset_content_type: application/vnd.android.package-archive
